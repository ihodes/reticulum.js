<!DOCTYPE html>
<html>
  <head>
    <title>retic://<%= id %></title>
    <script src="/js/d3.v3.min.js"></script>
    <script src="/js/underscore-min.js"></script>
    <script src="/js/state-renderer.js"></script>
    <link rel="stylesheet" href="/css/state-machine.css">

    <style>
      body { font: 14px sans-serif; }

      .boxd { padding: 11px; background: #f5f5f5; border: 1px solid #4d4d4d; }
      
      #diag { width: 100%; height: auto; padding: 0px; }

      pre { font-family: "Anonymous Pro"; font-size: 12px; }
    </style>
  </head>
  <body>
    <script>
    function capitalize(str) { return str.charAt(0).toUpperCase() + str.slice(1); }

    function prepareDisplay(fsmJson, currentState, globals) {
      d3.select('#text')
        .text(JSON.stringify(fsmJson.fsm, undefined, 2));
      d3.select('h2')
        .text(capitalize(fsmJson.name));
      d3.select('#info')
        .text(JSON.stringify(fsmJson, ['name','initialState','group'], 2)
              +" // "+
              JSON.stringify(globals || {}, undefined, 2));
      displayFsm(fsmJson.fsm, fsmJson.initialState, currentState);
    }

    d3.json("/v1/fsm/<%= id %>", function(error, fsmJson) {
      if (error) {
        d3.select('pre').text("404 NOT FOUND");
        return console.warn(error);
      } else {
        if(!_.isEmpty("<%= fsmMId %>")) {
          d3.json("/v1/fsm/<%= id %>/<%= fsmMId %>", function(error, fsmMJson) {
            prepareDisplay(fsmJson, fsmMJson.currentState.stateName,
                                    fsmMJson.currentState.globals);
          });
        } else {
            prepareDisplay(fsmJson);
        }
      }
    });
    </script>

    <h2></h2>
    <h4>Diagram</h4>
    <div id="diag" class="boxd">
      <img src="/imgs/loader.gif" alt="loader" class="loading" style="padding: 20px;">
    </div>
    <p>
      The initial state is indicated by a <b style="color:#333;">dark grey</b> node. A <b style="color:gold;">gold</b> node indicates the current state. <b style="color:green;">Green</b> transitions represent GeoEvents, and <b style="#666; border-bottom: 1px dotted #666;">grey dotted</b> transitions occur given a specific event name recieved.
    </p>
    <h4>Info</h4>
    <pre id="info" class="boxd"><img src="/imgs/loader.gif" alt="loader" class="loading"></pre>
    <br>
    <h4>JSON representation</h4>
    <pre id="text" class="boxd"><img src="/imgs/loader.gif" alt="loader"></pre>
  </body>
</html>
